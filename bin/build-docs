#!/usr/bin/env node
const fs = require('fs')
const path = require('path')
const marked = require('marked')
const hl = require('highlight.js')

marked.setOptions({
  highlight: code => {
    return hl.highlightAuto(code).value
  }
})

const componentsDir = path.join(__dirname, '..', 'src')
const outputFile = path.join(__dirname, '..', 'docs', 'index.html')
const dirs = fs.readdirSync(componentsDir)

const read = (...args) => {
  try {
    return fs.readFileSync(path.join(...args), 'utf8')
  } catch (e) {
    return ''
  }
}

const head = `
  <head>
    <title>Tonic - Component Based Architecture</title>
    <link href="https://fonts.googleapis.com/css?family=Caudex|Poppins:400,600|Space+Mono" rel="stylesheet">
    <link href="index.css" rel="stylesheet">
    <link rel="icon" type="image/png" href="./favicon.png">

    <meta http-equiv="Content-Type" charset="utf-8" content="text/html">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1 user-scalable=no">
    <meta name="description" content="Component Based Architecture">
  </head>
`

const intro = `
  <section id="intro">
    ${read(__dirname, '..', 'docs', 'src', 'intro.html')}
  </section>
`

const custom = `
  <section id="custom">
    ${marked(read(__dirname, '..', 'docs', 'src', 'custom.md'))}
  </section>
`

function page (toc, sections) {
  return `
    <html>
      ${head}

      <body>
        <div class="theme-picker">
          <svg>
            <use xlink:href="./sprite.svg#theme">
          </svg>
        </div>
        <nav>
          <a href="./index.html" class="logo">
            <svg>
              <use xlink:href="./sprite.svg#tonic_logo">
            </svg>
          </a>
          ${toc}
        </nav>
        <main>
          ${intro}

          ${sections}

          ${custom}

          <footer>
            <a href="#">
              <span>Made by</span>
              <svg>
                <use xlink:href="./sprite.svg#cl_logo">
              </svg>
            </a>
          </footer>
        </main>
        <script src="bundle.js"></script>
      </body>
    </html>
  `
}

let toc = ''
let sections = []

function readMarkdown () {
  let titles = []

  function wrapLink (str, i) {
    const selected = i === 0 ? 'selected' : ''

    return `
      <li>
        <a href="#${str.toLowerCase()}" class="${selected}">${str}</a>
      </li>
    `
  }

  function wrapSection (str, title) {
    return `<section id="${title.toLowerCase()}">${marked(str)}</section>`
  }

  for (const dir of dirs) {
    let s = read(componentsDir, dir, 'README.md')
    s = s.replace(/%html%/, read(componentsDir, dir, 'readme.html'))

    s = s.replace(/%js%/, `<script> {
      ${read(componentsDir, dir, 'readme.js')}
    } </script>`)

    if (s) {
      const { 0: match } = /^#\s*(.*)[\n|\r]/.exec(s)
      if (!match) continue

      const title = match.slice(1).trim()
      titles.push(title)
      sections.push({ title, content: wrapSection(s, title) })
    }
  }

  titles = titles.sort((a, b) => a.localeCompare(b))

  titles.unshift('Intro')
  titles.push('Custom')
  titles.push('APIs')
  titles = titles.map(wrapLink)

  toc = `<ul>${titles.join('')}</ul>`
}

readMarkdown()

sections = sections
  .sort((a, b) => a.title.localeCompare(b.title))
  .map(section => section.content)

const html = page(toc, sections.join(''))

fs.writeFileSync(outputFile, html)
